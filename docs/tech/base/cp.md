<p align="center"><font size=6><strong>计算机组成原理</strong></font></p>

<p align=center><font><strong>Waiyu Chan</strong></font></p>

## 一、冯诺依曼机
### 1. 特点归纳
```text
· 计算机硬件系统由运算器、存储器、控制器、输入设备、输出设备5大部件组成
· 指令和数据以同等地位存储在存储器中，并可按地址寻访
· 指令和数据均用二进制代码表示
· 指令由操作码和地址码组成，操作码表示操作的性质，地址码表示操作数在存储器中的位置
· 指令在存储器中按序存放，通常指令顺序执行，特定条件下可改变运算顺序
· 早期冯诺依曼机以运算器为中心，输入输出设备通过运算器与存储器传送数据
```

### 2. 存储器
#### （1）主存储器（主存）
cpu可直接访问的存储器，工作方式是按存储单元的地址存取；地址寄存器MAR、数据寄存器MDR。

#### （2）辅助存储器（辅存）
信息调入主存后才能被cpu调用【CPU+主存=主机】

### 3. 运算器
核心：算数逻辑单元ALU；包含若干通用寄存器，用于暂存操作数和中间结果，如**累加器ACC**、**乘商寄存器MQ**、**操作数寄存器X**、变址寄存器IX、基址寄存器BR等（前3个必须有）

### 4. 控制器
由程序计数器PC、指令寄存器IR、控制单元CU组成。PC存放当前欲执行指令的地址，可自动加1形成下一指令的地址，与主存MAR间有直接通路。IR存放当前指令，内容来自主存的MDR。

### 5. 总线
CPU与主存间的通路，有地址、控制和数据3组信号线。MAR中的地址信息直接送地址线，指向读写操作的主存单元；控制线中有读写信号线：写——数据从CPU写入主存，将数据线上的数据写入MDR；读——数据从主存读出到CPU，将MDR中的数据直接送数据线。

### 6. 三种不同层面的编程语言
#### （1）机器语言
二进制编码，计算机唯一可识别和执行的语言

#### （2）汇编语言
用英文单词或缩写代替二进制的指令代码经过汇编程序翻译以后转换成机器语言

#### （3）高级语言
设计人员使用的程序，经编译程序编译为汇编语言程序，经汇编操作得到机器语言程序。例如C、C++、Java、Python、Golang等等。

### 7. 计算机工作过程
```text
程序和数据装入主存 ——> 源程序转换成可执行文件 ——> 从可执行文件的首地址开始逐条执行指令
```

源程序转换为可执行文件的过程:
![alt 源程序转换为可执行文件的过程](/resources/pics/cp/源程序转换为可执行文件的过程.png)

### 8. 指令执行过程描述
```
取指令 -> 分析指令 -> 执行指令 （例：取数指令）
```

* 取指：
  ```
  PC -> MAR -> M -> MDR -> IR
  ```
  根据PC取指令到IR（pc内容送MAR，MAR中内容送地址线，控制器送读信号到控制线，主存从指定位置读指令送数据线，MDR从数据线接受指令，送IR）


* 析指：
  ```
  OP(IR) -> CU
  ```
  指令译码并送出控制信号（控制器根据IR中指令操作码生成相应控制信号送到不同执行部件）


* 执行指令：
  ```
  AD(IR) -> MAR -> M -> MDR -> ACC
  ```
  取数操作（IR中指令地址码送MAR，MAR内容送地址线，控制器送读信号到控制线，从主存读操作数送数据线，MDR读数据送ACC）

### 9. 计算机层次结构
![alt 计算机层次结构](/resources/pics/cp/计算机层次结构.jpg)

### 10、计算机主要性能指标
* 机器字长：计算机一次整数运算能处理的二进制数据位数，通常与CPU寄存器位数、加法器有关，是字节的整数倍
* 指令字长：一个指令字包含的二进制代码的位数，是字节的整数倍
* 存储字长：一个存储单元存储的二进制代码的长度，是字节的整数倍
* 数据通路宽带：数据总线一次能并行传递信息的位数
* 主存容量：主存所能存储信息的最大容量
* 吞吐量：系统单位时间内处理请求的数量
* 响应时间：从用户提交请求到系统首次产生响应并获得其需要的结果所用时间
* 主频：机器内部主时钟的频率，时钟周期的倒数
* CPI ：执行一条指令所需的时钟周期数
* 执行时间：运行一个程序所花费的时间
* MIPS ：每秒执行多少百万条指令
* FLOPS ：每秒执行多少次浮点运算
* 透明性：用户看不到的

## 二、数据表示与运算
* 十进制转其他进制：除基取余法【除基取余，先余为低，后余为高】
* 真值：带+、-符号的数，是机器数所代表的实际值
* BCD码：用4位二进制数表示一位十进制数，如8421码、余3码、2421码
* 校验码：能自动发现或自动纠正错误的数据编码（原理：增加冗余码用于检验纠错）
    * 奇偶校验码
    * 海明码（一种多重奇偶校验码）
    * 循环冗余校验码（CRC）
* 有符号数：0正1负，最高位为符号位，原码、补码、反码、移码都是有符号数
* 定点数：约定机器数的小数点位置固定不变。定点小数是纯小数，小数点位置在符号位后有效数值之前；定点整数是纯整数，小数点位置在最后。
* 原码：机器数最高位表示符号，其余各位表示数的绝对值
* 补码：正数的原码补码相同，负数的补码等于原码符号位不变数值部分按位取反末位加1
* 反码：原码和补码互相求的过渡
* 移码：真值加一个常数，只表示整数
* 数据存储：大端法，按从最高有效字节到最低有效字节顺序存储，最高有效字节放前面。小端法反之。
* 浮点数
    * 浮点数规格化：规定尾数最高位是一个有效值
    * 浮点数加减步骤：对阶、尾数求和、规格化
    * IEEE754标准：浮点数表示方面。舍入方式：就近舍入（舍入为最相近的数）、正向舍入（取舍入位置右边那个数）、负向舍入（取舍入位置左边那个数）、截去（取绝对值最小那个数）
* 算数逻辑单元：一位全加器（最基本）、串行加法器（前者简单相连，串行进位）、并行加法器（先行进位）、ALU（组合逻辑电路，多种算术运算和逻辑运算）

## 三、存储系统
### 1. 存储器分类
按在计算机中作用（层次）：主存、辅存、cache

按存储介质：磁表面存储器、半导体存储器、光存储器

按存取方式：

* 随机存取存储器：按地址访问存储器任一单元【RAM（任何一块内容都可随机存取）、只读存储器ROM（只可随机读出不可写入）】
* 顺序存取存储器SAM：只能按某种顺序存取，定位->数据读写。
* 直接存取存储器DAM：介于随机存储器和顺序存取存储器间，先寻找某个小区域（如磁盘的磁道），再在小范围内顺序查找。
* 按信息可保存性：易失性存储器（断电后存储信息消失如RAM）、非易失性存储器（断电后存储信息不消失如ROM）。

### 2. 存储器相关概念
* 破坏性读出：读出信息后院存储信息被破坏，读出操作后要紧跟再生操作恢复数据。
* 非破坏性读出：读出信息后院存储信息不被破坏。
* 存储器性能指标：存储容量、单位成本、存储速度
* 计算机三级存储体系：外存+内存+cache

### 3. Cache与主存之间的映射
解决CPU与主存速度不匹配问题，对用户透明，以固定大小数据块为单位进行交换

#### （1）Cache与主存之间的映射3种方式

![alt Cache与主存之间的直接映射](/resources/pics/cp/Cache与主存之间的直接映射.jpg)

##### A. 直接映射
* Cache只分块不分组，主存分块也分组，每组块数=cache块数
* 映射规则——主存每个数据块只能映射到与其组内序号相同的cache数据块位置

![alt Cache与主存之间的全相联映射](/resources/pics/cp/Cache与主存之间的全相联映射.jpg)

##### B. 全相联映射
* Cache只分块不分组，主存只分块不分组
* 映射规则——主存任何一个块都可以映射到Cache任何一个数据块位置上

![alt Cache与主存之间的组相联映射](/resources/pics/cp/Cache与主存之间的组相联映射.jpg)

##### C. 组相联映射
* Cache分块也分组，主存分块也分组，每组块数=cache块数
* 映射规则——主存数据块映射到与自己组内块序号相同的cache分组，可占据cache分组中任意数据块位置

##### D. 总结
* 定位cache的分组：直接映射
* 定位cache数据块：全相联映射/组相联映射——2者折中

### 4. 替换算法
* 最不经常使用LFU：将一段时间内被访问次数最少的那块从cache中置换出去
* 近期最久未使用LRU：将近期内最久未被访问过的cache块置换出去
* 随机替换：随机确定将哪块从cache中替换出去

### 5. Cache写操作
CPU发出写请求时如果Cache命中：
* 通写：cache单元和主存单元同时写，使主存与cache保持一致
* 回写：只修改cache单元，并用标志将该块注明，当该块从cache中替换出来时一次性写入主存

### 6. Cache读操作
* 旁路式读(Look-Aside)：CPU向Cache和主存同时发读命令和地址
  。Cache命中，则Cache回送数据并中断读主存命令； Cache未命中，则直接访问主存读取数据。
  通过式读(Look-Through)：CPU首先向Cache发读命令和地址。Cache命中，则从Cache中读出数据； Cache未命中，再将读命令和地址传给主存并读主存。

### 7. 虚拟存储

![alt 虚拟存储与主存](/resources/pics/cp/虚拟存储与主存.jpg)

* 内存与外存之间由操作系统存储管理模块及相关硬件实现的一种存储映射技术，逻辑上提供比物理存储器更大的虚拟存储空间，相关地址称为虚拟地址或逻辑地址。

### 8. 内存与外存的映射

![alt 页式虚拟存储器地址转换](/resources/pics/cp/页式虚拟存储器地址转换.jpg)

* 基本方法：关联表
* 页式虚拟存储管理：主存和外存统一分页后进行管理。
* 页表：记录虚地址页号与实地址页号的对应关系，即虚页面调入主存时被安排在主存中的位置（实页号）。页表中的每一行，称为页表项。
* 页表基址寄存器：记录页表在主存中的起始地址，页表项的地址a=页表基址b+页号n×表项的字节数w。
* 快表(TLB)：把活跃的页表项用高速存储器单独存储，访问速度更快，它是页表的子集。

![alt 段页式虚拟存储器地址转换](/resources/pics/cp/段页式虚拟存储器地址转换.jpg)

* 段式虚拟存储器管理：虚存中的程序分段（按照代码段、数据段和共享段等）进行管理。为了将虚拟地址变换成主存实地址，操作系统创建1个段表。每段在段表中都占有一登记项，内容包括： 段号、段起点、段长、装入位等。

### 9. 半导体存储原理及芯片
* MROM：掩模型只读存储器，存储信息固定不可改写，如字符点阵存储器等
* PROM：可编程只读存储器，写入操作不可逆，无法重写
* EPROM：擦除型可编程只读存储器，紫外线照射擦除数据，只读，需专门擦除器
* EEPROM：电擦除型可编程只读存储器，高电压擦除数据，只读，需专门擦写器
* FLASH：闪存，快速擦写型ROM，掉电不丢失，可在计算机内擦写，不需专门擦写器，如U盘、SSD固态硬盘等

### 10. 半导体存储器设计原则
* 接口协议匹配、存储芯片选择、存储器地址分配和地址译码、芯片布局和排线
* 逻辑设计：芯片选用、片内地址分配和片选逻辑、信号线连接

### 11. 动态存储器的刷新
* 定期向电容补充电荷，与读写操作无关，根据行地址逐行刷新

【 VS 重写：破坏性读出后的自动操作，以恢复原来信息】

【 VS CPU访存：CPU通过地址总线提供行列地址随机访问】

### 12. 光学存储器
* 原理：用激光照射存储介质使其发生某种物理化学的特性变化，据此记录信息

### 13. 磁表面存储器（磁盘）
* 存储介质：磁层；读写部件：磁头

* 磁盘系统组成：硬件（盘片、磁盘驱动器、磁盘控制器和接口）、软件（磁盘驱动程序）

* 硬盘：盘片+盘组（多个盘片组成） + 磁盘阵列（RAID，多个盘组组成）

![alt 磁盘结构简图](/resources/pics/cp/磁盘结构简图.jpg)

* 圆柱面：各记录面上相同序号的磁道构成一个圆柱面

* 寻址方式：
  ```
  驱动器号（确定硬盘） -> 圆柱面号（确定柱面） -> 磁头号（确定磁面） -> 扇区号（定位扇区） -> 字节序号（定位字节）
  ```


## 四、CPU子系统
### 1. CPU
* 基本功能：数据运算功能、系统控制功能；
* 主要部件：运算部件、缓存部件、寄存器、控制器、时序部件，通过数据通路、控制通路互相连接 ——> CPU微架构

    * 缓存部件：缓存从主存读取的部分指令、数据
    * 寄存器组：
        * 通用寄存器（有全局唯一地址，可通过地址码访问，可在机器指令中直接使用）
        * 暂存器（无需分配地址码，不能在机器指令中使用）
        * 指令寄存器（IR，存放指令代码）
        * 程序计数器（PC，仅1个，指明指令在存储器中的存放位置）
        * 程序状态字寄存器（PSW，仅1个，记录现行程序的运行状态和工作模式）
        * 地址寄存器（MAR，仅1个，存放目标单元地址码）
        * 数据缓冲寄存器（MBR，仅1个，过渡性存放CPU与主存间交换的数据）
        * 堆栈指针（SP，仅1个，固定存放堆栈的栈顶单元的地址码）
    * 控制器：根据指令、时钟信号、外部信号等信息，产生各种控制信号(微命令)，以便控制各种功能部件协同工作，完成指令的功能。两类控制单元：①组合逻辑控制器：组合逻辑硬件电路→控制信号 ②微程序控制器：微程序译码→控制信号
    * 时序：指令周期包含若干机器周期，机器周期包含若干时钟周期

![alt 时序](/resources/pics/cp/时序.jpg)

### 2. CPU工作原理
* 主要功能：处理指令-控制指令的执行顺序； 执行操作-产生控制信号控制部件工作；控制时间-控制各步操作的时序； 数据运算-算术和逻辑运算；
* 执行指令的流程：读取指令-从存储器中读取；指令译码-通过控制器进行、产生控制信号； 指令执行-寻址、取数、运算；后续工作-保存结果、响应外部请求等；
* 控制方式：
    * 同步控制-每步操作都向统一的外部时序信号对齐，各步操作之间无交互；
    * 异步控制方式-每步操作都不需向统一的外部时序信号对齐，各步操作之间通过交互应答来实现协同
* CPU在I/O控制中的任务：主机←接口→外围设备
* 主机与外设之间进行数据输入/输出操作时，在不同的I/O控制模式下，CPU承担的任务各不相同：
    * 程序传送模式：CPU直接执行I/O指令；
    * 中断模式： CPU执行中断服务程序；
    * DMA模式： CPU管理DMA控制器、善后处理；
    * IOP和PPU模式：CPU组织I/O程序，管理IOP与 PPU，以及善后处理；

## 五、指令
* 指令instruction：计算机执行某类操作的信息的集合，是CPU工作的主要依据。
* 指令集instruction set：处理器能执行的全体指令的集合（CISC复杂指令集、RISC精简指令集）
* CISC复杂指令集的计算特点：指令数量多；指令长度可以不固定，指令格式和寻址方式多样；很多指令会涉及存储器读写操作，指令周期长；一般在通用处理器中使用
* RISC精简指令集计算特点：指令数量少；指令长度固定，指令格式和寻址方式种类也少；一般只有少量指令(如取数/存数) 才会读写存储器，其余指令只涉及CPU内部寄存器，指令周期短；一般在高端服务器CPU中使用
* 指令格式：操作码+地址码/操作数
* 指令字长：定长、变长
* 操作码结构：定长操作码、扩展操作码、复合型操作码
* 地址结构：指令中提供地址偏移量/立即数和寄存器编号，地址提供方式包括显式和隐式。
* 常见地址结构：
    * 四地址结构指令（指令+操作数地址2个+结果地址+下条指令地址）
    * 三地址结构指令（指令+操作数地址2个+结果地址）
    * 二地址结构指令（指令+目的地址+源地址）
    * 一地址结构指令（指令+源/目的地址）、零地址结构指令（特殊指令）
* 指令中的寻址方式：形成操作数地址或寻找操作数的方式
    * 立即寻址：指令中包含操作数，用来提供偏移量、常数、设置初值等
    * 直接寻址：指令中直接给出操作数的地址码（如果是存储单元地址：绝对寻址/主存直接寻址；如果是寄存器编号：寄存器直接寻址）
    * 间接寻址：指令给出操作数的间接地址，按存储单元地址/寄存器编号分为主存间接寻址/寄存器间接寻址，若给出的是堆栈指针，则为堆栈间接寻址
    * 变址寻址：指令给出一个寄存器号和一个地址量（形式地址），寄存器内容与地址量之和为有效地址
    * 基址寻址：指令给出一个寄存器号和一个地址量（位移量），寄存器内容与地址量之和为有效地址
    * PC相对寻址：指令给出偏移量，PC当前值与偏移量相加得到有效地址，一种特殊的基址寻址方式
    * 页面寻址（伪直接寻址）：指令给出位移量，PC的高位部分与位移量拼接，形成有效地址，用于页式存储系统，寻址速度快

注释：变址寻址：指令提供基准量，寄存器提供偏移量； 基址寻址： 指令提供偏移量，寄存器提供基准量】【处理三维数组：基址+变址（变址寄存器号、基址寄存器号、位移量，求和得有效地址）

* 寻址方式约定：操作码、寻址方式字段
* 指令分类：
    * 数据传送类（取数指令、存数指令、数据传送(单字、成组)、数据交换和堆栈操作等）
    * I/O指令；算数/逻辑运算指令（加法减法与或异或）；程序控制类【转移指令（无条件转移：操作码+转移地址）（条件转移：操作码+转移地址+转移条件）（循环：转移条件为循环计数值）、转子指令（=调用，操作码+子程序入口）、返回指令（操作码+返回地址<堆栈的顶单元中>）、软中断指令（常用于系统功能的调用）】
* 控制信号产生：
    * 硬连线（基于组合逻辑，控制信号的产生速度比微程序快，设计不规整，不容易修改或扩展）
    * 微程序（基于存储，用存储逻辑代替硬连线逻辑，结构规整；容易修改和扩展、灵活、通用性强；控制信号的产生比组合逻辑慢；可靠性较高，易于诊断和维护）
* 单周期CPU特性：
    * （1）指令周期与时钟周期等长，且宽度较大；
    * （2）处理器的CPI≡1；
    * （3）在指令周期中，各种硬件资源均被相应的功能操作独占，不能共享，硬件利用率低；
    * （4）所有指令无论其实际执行时间长短，均分配较 长的时钟周期，时间浪费严重；
    * （5）对简单的小规模指令集支持较好；难胜任浮点或更复杂指令集；
* 多周期CPU特性：
    * （1）缩短时钟周期，可以为不同的指令安排多个时钟周期，CPI≥2；
    * （2）不同类型指令分配的时钟周期数可以不同；
    * （3）指令周期的长度一般会变长，执行速度降低；
    * （4）硬件可共享，硬件资源的综合利用率高。
* 流水技术：把指令过程分解为若干子过程，每个子过程都可有效地在其专用功能段上与其它子过程重叠执行。流水线的子过程称为流水线的“级”或“段”，子过程的数目称为流水线的“流水深度”(m)。每个子过程由专用的功能段实现，各功能段的时间应基本相等，通常为1个时钟周期（1拍）。
* 标量流水线：在每个时钟周期只发射1条指令，并要 求每个时钟周期只从流水线流出一条指令的结果。
* 超标量流水线：指在每个时钟周期向流水线发射多条指令，并能从流水线流出多个结果。
* 超流水线：把完成一条指令的流水线的各一级子过程进一步细分成若干二级子过程。
* SMT（Simultaneous Multithreading）：同步多线程，使CPU能够执行分别来自多个线程的指令（一种硬件多线程技术）。
* 多核处理器：也称为片上多处理器，主要特征是在一个处理器芯片上集成多个CPU内核。

## 六、总线和I/O子系统
### 1. 总线
* 总线(bus)： 一种用来连接各功能部件并承当部件之间信息传送任务的信息公共通路【数据总线、地址总线、控制总线】
* 总线周期：通过总线完成一次完整数据传输的时间。
* 主设备： 申请并掌握总线权限的设备。
* 从设备：与主设备对应的设备。
* 总线操作：
    * 主设备申请总线，仲裁器裁决并批准
    * 主设备掌握总线，启动总线周期，初始化
    * 从设备响应，主从设备之间数据传输
    * 主设备释放总线，结束总线周期
* 总线的数据传输模式：
    * 单周期模式-传输特点：申请1次，只分配1个总线周期，只传送1次数据；
    * 突发模式(burst)-传输特点：申请1次，分配多个总线周期，可传输多个数据字。
* 总线的时序和控制：
    * 同步总线：由统一的时序信号控制总线上的传送操作。在固定时钟周期内完成传送，由同步脉冲定时打入
    * 异步总线：无固定的时钟周期划分；总线周期由传送的实际需要决定；以异步应答方式控制总线传送操作
    * 扩展的同步总线：以时钟周期为时序基础，允许总线周期中时钟数可变
* 三种周期：
    * 时钟周期： CPU一步操作(1次内部数据通路传送)时间
    * 总线周期：经过总线的一次数据传送(访存)时间，通常包含若干时钟周期
    * 工作周期：指令周期中的一个操作阶段。可包含多个总线周期。】
* 总线仲裁：解决总线上多个设备对总线控制权的竞争问题，一般采用优先级或公平策略进行仲裁。
    * 集中式仲裁：送往仲裁器的总线请求（BR）信号线、仲裁器送出的总线授权（BG）信号线三种方式1链式查询（离总线控制器的逻辑距离决定，越近优先级越高）2计数器定时查询（查询计数器计数值与发出请求的设备编号一致时，中止查询，该设备获总线控制权）3独立请求方式（各设备均通过专用请求信号线与仲裁器连接，且通过独立的授权信号线接收总线批准信号）
    * 分布式仲裁：设备需要控制总线时，发请求信号，并监听其它请求信号，各设备能判别自己的优先级、以及能否在下一周期控制总线

### 2. I/O子系统
* I/O接口：主机和外设的衔接部分，位于总线和外部设备之间
    * 基本功能：
        * (1)设备寻址 接收CPU送来的地址码，选择接口中的寄存器供CPU访问。
        * (2)数据缓冲 实现主机与外设的速度匹配，缓冲深度与传送的数据量有关。
        * (3)预处理功能 串-并格式转换（串口） 数据通路寬度转换（并口）高-低电平转换。
        * (4)控制逻辑功能 接收主机CPU的控制命令、保存状态信息，协助主机实现对I/O传送操作的控制
* 接口中寄存器编址：单独编址（每个寄存器分配独立端口，可与主存地址重叠）、与主存统一编址（把寄存器当成特殊的主存单元，与其他主存单元统一编址）
* 接口分类：
    * 按数据传送格式分为串行接口（接口与外设一侧串行传送）和并行接口（接口两侧均并行传输数据）
    * 按时序控制方式分为同步接口（接口与系统总线的信息传送采用同步方式控制）和异步接口（接口与系统总线的信息传送采用异步方式控制）
    * 按IO操作的控制方式分为PIO接口、中断接口、DMA接口、IOP/PPU接口

## 七、IO操作的4种工作模式  （主-外=主机和外设）
### 1. 直接程序传送方式（PIO）
* 主CPU执行I/O程序，不断查询外设状态，进而控制具体的数据I/O过程，实现主-外的数据I/O。数据I/O过程中主CPU无法执行其它计算任务。
* 优缺点：硬件开销小, 实时处理能力差，并行程度低
* 应用场合：I/O效率要求不高、数据量少，如外设的诊断或调试

### 2. 程序中断方式
在程序运行过程中,如果发生某种随机事态，CPU暂停当前程序(被中断)，转而执行该事态对应的服务程序，结束后再恢复原程序的执行。

* 实质：程序切换。
* 方法：保存断点，保护现场；恢复现场，返回断点。
* 时间：指令结束时切换，保证程序完整性。
* 特点：随机性【包括：随机发生的事态（按键、故障）；有意调用,随机请求与处理的事态（调用打印机）；随机插入的事态（软中断指令插入程序任何位置）】

中断VS子程序调用：
* （1）子程序的执行由程序员事先安排，而中断服务程序的执行则是由随机中断事件触发。
* （2）子程序的执行受主程序或上层程序控制，而中断服务程序一般与被中断的现行程序无关。
* （3）一般不存在同时调用多个子程序，但可能发生多个外设同时向CPU发出中断服务请求的情况。

* 中断的软硬件组织：
    * 软件【终端服务程序、中断向量表】
    * 硬件【接口方面（请求、判优等逻辑）
    * CPU方面（中断请求的响应逻辑）】

* 中断组织方法：
  ```
  列出各种中断请求 --> 为各中断源编制中断服务程序 --> 将中断服务程序的入口地址写入中断向量表
  ```

* 中断分类：
    * 硬件中断（硬件请求信号引发）与软中断（软件触发）；
    * 内中断（中断源在主机内部）与外中断（中断源在主机外部）；
    * 强迫中断（非程序的安排，由故障和外部源引起）与自愿中断（程序中有意安排，自中断或软中断）；
    * 可屏蔽中断（可通过屏蔽字屏蔽该类请求，关中断时不响应）与非屏蔽中断（与屏蔽字无关，请求响应与开/关中断无关）；
    * 向量中断（由硬件方式确定服务程序入口地址）与非向量中断（由软件查询确定服务程序入口地址）

* 中断源优先级：故障 > DMA > 外部设备引起的中断（原则：高速操作优先于低速操作,输入优先于输出）
* CPU当前程序与外设请求判优：先查询CPU允许中断标志（=1，开中断；=0，关中断），然后再分析当前程序优先级，比较，当前的程序优先级高就不响应外设请求。
* 多个中断请求间判优：软件查询顺序确定优先级、硬件（中断控制器）判优。

### 3. CPU对中断请求的响应

* 响应条件：有未被屏蔽中断请求到达，CPU处于开中断模式，中断源优先级高于当前程序优先级，CPU刚执行完一条指令。
* 形成中断服务程序的入口地址：（1）如果是非向量中断：通过程序【将所有中断源的中断服务程序入口地址组织在公共查询程序中；CPU响应时执行此查询程序，确定中断源对应的服务程序入口地址】。（2）如果是向量中断：通过硬件【将所有中断源的中断服务程序入口地址(中断向量)组织在中断向量表中；CPU响应时由硬件产生向量地址，据此查中断向量表确定服务程序入口地址】
* 中断向量：中断服务程序的入口地址+状态字PSW。
* 中断向量表：用来存放中断向量的表 （一段存储区）。
* 向量地址：用来访问向量表的地址（也叫中断指针）。

### 4. 中断响应过程（向量中断方式）

#### （1）执行中断隐指令
由硬件自动完成过程，
```
CPU发送信号 ---> 关中断、保存断点和状态字PSW ---> 取中断号，转换为向量地址，访问中断向量表 ---> 读取中断向量，准备执行中断服务程序
```

#### （2）执行中断服务程序
* 单级中断：
  ```
  保护现场 ---> 具体服务处理 ---> 恢复现场 ---> 开中断返回
  ```

* 多重中断：
  ```
  保护现场 ---> 送新屏蔽字（更高级的）、开中断 ---> 具体服务处理 ---> 关中断 ---> 恢复现场及原屏蔽字 ---> 开中断返回
  ```

* 在响应过程、保护现场、恢复现场等关键阶段，应关中断以防止被打扰。

### 5. 中断工作过程：
```
初始化（设置工作方式，送屏蔽字，分配中断类型码） ---> 送命令字，启动设备 ---> 设备就绪，申请中断 ---> 中断控制器汇集各请求，经屏蔽和判优形成中断号，向CPU发出INT ---> CPU响应，发出批准INTA ---> 中断控制器送出中断号 ---> CPU执行中断隐指令操作，准备执行服务程序。
```

## 八、直接存储器访问（DMA）方式
直接依靠硬件系统来控制主存与外设之间的数据传送, 传送期间无需CPU干预，传送结束后通常用中断方式通知CPU。

* 特点与应用：响应随机请求；一般不影响CPU程序的执行，仅占用总线、无程序切换；大批量数据的简单传送。

* 数据传送模式：单字传送（DMA请求被批准后，CPU分配1个总线周期用于字节传送，再重新分配下一个总线周期的控制权）、成组连续传送（多个总线周期）。

* DMA控制器功能：
    * （1）接收初始化信息（地址、传送方向、主存首址、交换量）
    * （2）接收外设DMA请求、判优、向CPU申请总线传送前
    * （3）接管总线控制权，发出寻址、读/写命令I/O期间
    * （4）接收初始化信息（外设寻址信息）
    * （5）向DMA控制器发请求传送前，外设准备好
    * （6）通过总进行线数据I/O传送期间

* DMA初始化工作的步骤：
    * (1) 向接口送出I/O设备的寻址信息
    * (2) 向DMA控制器送出控制字，如传送方向
    * (3) 向DMA控制器送出主存缓冲区首址
    * (4) 向DMA控制器送出传送的数据量。

* 硬盘DMA方式调用过程：
    * (1) CPU向适配器送出驱动器号、圆柱面号、磁头号、 起始扇区号、扇区数等外设寻址信息；向DMA控制器送出传送方向、主存首址、交换量等初始化信息
    * (2) 适配器启动寻道，并用中断方式判寻道是否正确 (如不正确，重新寻道；正确，启动磁盘读/写)
    * (3) 判断适配器准备是否准备好，发出DMA请求
    * (4) CPU响应DMA请求，由DMA控制器接管总线，执行传送
    * (5) 批量传送完毕，适配器申请中断
    * (6) CPU响应中断请求，执行I/O操作的后续处理。

## 九、IOP或PPU方式（专用处理器/处理机）
* IOP：输入输出处理器。PPU：外围处理单元
* 思路：主机CPU外增设专用的IO处理单元。受主机CPU控制；可独立执行程序(指令)，以控制更复杂的I/O操作；较好的对多种设备的适应性；可与主机CPU并行工作
* 优点：把CPU从繁杂的I/O任务中解脱出来，与I/O操作并行执行，能显著提高计算机系统的I/O处理能力
* IOP举例：通道。分为选择型通道、多路型通道
* 选择型通道：可同时连接多个外设，但每次只能选择1个设备工作，该设备的I/O操作完成后，再切换设备
* 多路型通道：可连接多路外设，每个通路仅连接1个外设；每次只能选择1路设备进行I/O操作；每次只传输1或多个字节（字节多路型或数组多路型），重新选择通路(外设）。

* 通道的工作过程：
    * (1) 程序提出I/O请求，CPU响应后组织通道程序并存储到主存，保存首地址(CAW)和数据传输量等
    * (2) 初始化通道和设备号，发出启动命令
    * (3) 通道接收启动命令，读取CAW(从主存72H)
    * (4) 通道对外设寻址，连接到外设
    * (5) 读取通道程序的首条通道命令字CCW，启动外设，执行CCW
    * (6) 继续读取执行CCW来控制I/O操作，更新通道状态字寄存器CSWR
    * (7) I/O操作结束，通道发出结束命令、中断请求，将 CSWR的内容保存到主存单元(64H)
    * (8) CPU响应中断，切换到服务程序进行I/O善后处理



